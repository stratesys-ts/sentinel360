{% extends 'base.html' %}
{% block title %}{{ project.name }} - Tarefas{% endblock %}
{% block page_title %}{{ project.name }}{% endblock %}

{% block extra_css %}
<style>
  .project-tabs {
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 1rem;
      gap: 0.25rem;
  }
  .project-tabs .nav-link {
      border: 1px solid transparent;
      border-bottom: 2px solid transparent;
      color: #6b7280;
      padding: 0.65rem 1rem;
      border-radius: 0.5rem 0.5rem 0 0;
      font-weight: 600;
  }
  .project-tabs .nav-link.active {
      color: #111827;
      border-color: #e5e7eb;
      border-bottom-color: #fff;
      background: #fff;
      box-shadow: inset 0 -2px 0 #6366f1;
  }
  .project-tabs .nav-link:hover {
      color: #111827;
      background: #f3f4f6;
  }
  /* Improve badge contrast for priority/status */
  .badge {
      font-weight: 600;
      padding: 0.35rem 0.65rem;
      border-radius: 999px;
      font-size: 0.85rem;
  }
  .badge-danger { background: #fde8e8; color: #9b1c1c; }
  .badge-info { background: #e0f2fe; color: #0f3e68; }
  .badge-secondary { background: #f4f5f7; color: #374151; }
  .badge-success { background: #def7ec; color: #0f5132; }
  .task-count {
      color: #6b7280;
      font-weight: 600;
      font-size: 0.75rem;
  }
  .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.45rem 0.95rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.85rem;
      letter-spacing: 0.02em;
  }
  .status-in-progress {
      background: #148554;
      color: #fff;
  }
</style>
{% endblock %}

{% block content %}
<div class="card" style="padding: 1.25rem 1.25rem 0 1.25rem;">
  <div class="card-header" style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; border: none; background: transparent; padding: 0 0 1rem 0;">
    <div style="display:flex; align-items:center; gap:0.35rem;">
      <h3 style="margin: 0; display: flex; align-items: baseline; gap: 0.4rem;">
        {{ project.name }}
        <span class="task-count">({{ tasks|length }})</span>
      </h3>
      {% include "projects/project_edit_icon.html" %}
    </div>
    {% if project.status == 'IN_PROGRESS' %}
    <span class="status-badge status-in-progress">{{ project.get_status_display|default:"" }}</span>
    {% else %}
    <span class="badge badge-info">{{ project.get_status_display|default:"" }}</span>
    {% endif %}
  </div>
  <div class="card-body" style="padding-top: 0;">
    {% include "projects/project_base_tabs.html" with active_tab="tarefas" %}
  </div>
</div>

<div class="card mt-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h3 class="mb-0">Tarefas</h3>
    <span class="text-muted small">Resumo das tarefas do projeto</span>
  </div>
  <div class="card-body p-0">
    <table class="table mb-0">
      <thead>
        <tr>
          <th style="width: 80px;">ID</th>
          <th>Titulo</th>
          <th>Responsavel</th>
          <th>Prioridade</th>
          <th>Status</th>
          <th>Data Inicio</th>
          <th>Data Fim</th>
          <th style="text-align:center; width:110px;">Acoes</th>
        </tr>
      </thead>
      <tbody>
        {% if tasks %}
          {% for task in tasks %}
            <tr>
              <td>
                <a href="{% url 'projects:task_edit' task.id %}" style="color: var(--primary-color); font-weight: 600;">
                  #{{ task.public_id|default:task.id }}
                </a>
              </td>
              <td>{{ task.title }}</td>
              <td>
                {% if task.assigned_to %}
                  {{ task.assigned_to.get_full_name|default:task.assigned_to.username|default:"-" }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if task.priority == 'HIGH' %}
                  <span class="badge badge-danger">Alta</span>
                {% elif task.priority == 'LOW' %}
                  <span class="badge badge-secondary">Baixa</span>
                {% else %}
                  <span class="badge badge-info">Média</span>
                {% endif %}
              </td>
              <td>
                {% if task.status == 'DONE' %}
                  <span class="badge badge-success">Concluída</span>
                {% elif task.status == 'DOING' %}
                  <span class="badge badge-info">Em andamento</span>
                {% else %}
                  <span class="badge badge-secondary">A fazer</span>
                {% endif %}
              </td>
              <td>{{ task.start_date|date:"d/m/Y"|default:"-" }}</td>
              <td>{% if task.due_date %}{{ task.due_date|date:"d/m/Y" }}{% else %}-{% endif %}</td>
              <td style="text-align:center;" class="text-nowrap">
                <a href="{% url 'projects:task_edit' task.id %}" title="Editar"
                   style="color:#674ea7; margin-right:0.7rem; font-size:1.1rem;">
                  <i class="fas fa-edit"></i>
                </a>
                {% if perms.projects.delete_task %}
                <form action="{% url 'projects:task_update' task.id %}" method="post" style="display:inline;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="delete">
                  <input type="hidden" name="redirect_to" value="{{ request.get_full_path }}">
                  <button type="submit" title="Excluir"
                    style="background:none;border:none;color:#d9534f;font-size:1.1rem;cursor:pointer;padding:0 0.2rem;"
                    onclick="return confirmDelete(event, this.form);">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </form>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="4" class="text-center text-muted py-4">Nenhuma tarefa cadastrada.</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
  <a href="{% url 'projects:project_list' %}" class="btn-back">
    <i class="fas fa-arrow-left"></i> Voltar
  </a>
</div>

{% block extra_js %}
{{ block.super }}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const quickAddMenu = document.getElementById('quickAddMenu');
    if (quickAddMenu) {
      const taskLink = quickAddMenu.querySelector('[data-quick-add="task"]');
      if (taskLink) {
        const url = new URL(taskLink.href, window.location.origin);
        url.searchParams.set('project', '{{ project.pk }}');
        taskLink.href = url.toString();
      }
    }
  });
</script>
{% endblock %}
{% endblock %}
