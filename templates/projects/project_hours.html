{% extends 'base.html' %}
{% block title %}Projeto {{ project.name }} - Horas trabalhadas{% endblock %}

{% block extra_css %}
<style>
  .project-tabs {
      border-bottom: 1px solid #e5e7eb;
      margin-bottom: 1rem;
      gap: 0.25rem;
  }
  .project-tabs .nav-link {
      border: 1px solid transparent;
      border-bottom: 2px solid transparent;
      color: #6b7280;
      padding: 0.65rem 1rem;
      border-radius: 0.5rem 0.5rem 0 0;
      font-weight: 600;
  }
  .project-tabs .nav-link.active {
      color: #111827;
      border-color: #e5e7eb;
      border-bottom-color: #fff;
      background: #fff;
      box-shadow: inset 0 -2px 0 #6366f1;
  }
  .project-tabs .nav-link:hover {
      color: #111827;
      background: #f3f4f6;
  }

  .summary-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.04);
  }
  .chip-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 0.5rem;
  }
  .chip {
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      padding: 0.5rem 0.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f8fafc;
      font-weight: 600;
  }
  .chip .badge {
      background: #eef2ff;
      color: #4f46e5;
  }

  .accordion .accordion-item {
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.04);
  }
  .accordion-button {
      background: linear-gradient(90deg, #eef2ff, #f8fafc);
      font-weight: 700;
      color: #111827;
  }
  .accordion-button:focus {
      box-shadow: none;
  }
  .accordion-button .rotate-icon {
      transition: transform 0.2s ease;
  }
  .accordion-button.collapsed .rotate-icon {
      transform: rotate(-90deg);
  }
  .table-modern thead th {
      background: #f8fafc;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.02em;
      color: #6b7280;
      border-bottom: 1px solid #e5e7eb;
  }
  .table-modern tbody tr td {
      border-color: #f1f5f9;
  }
  .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.45rem 0.95rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.85rem;
      letter-spacing: 0.02em;
  }
  .status-in-progress {
      background: #148554;
      color: #fff;
  }
</style>
{% endblock %}

{% block content %}
<div class="card" style="padding: 1.25rem 1.25rem 0 1.25rem;">
  <div class="card-header" style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; border: none; background: transparent; padding: 0 0 1rem 0;">
    <h3 style="margin: 0;">{{ project.name }}</h3>
    {% if project.status == 'IN_PROGRESS' %}
    <span class="status-badge status-in-progress">{{ project.get_status_display|default:"" }}</span>
    {% else %}
    <span class="badge badge-info">{{ project.get_status_display|default:"" }}</span>
    {% endif %}
    <span class="text-muted small">Total de horas: {{ total_hours|default:0 }}</span>
  </div>
  <div class="card-body" style="padding-top: 0;">
    {% include "projects/project_base_tabs.html" with active_tab="horas" %}
  </div>
</div>

<div class="accordion mt-3" id="monthAccordion">
  {% for key, month in month_groups %}
  {% with cid="month-"|add:key|slugify %}
  <div class="accordion-item mb-2">
    <h2 class="accordion-header" id="heading-{{ cid }}">
      <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#{{ cid }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}" aria-controls="{{ cid }}">
        <div class="d-flex justify-content-between align-items-center w-100">
          <span class="fw-semibold">{{ month.label }}</span>
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-light text-dark">Total: {{ month.total }}</span>
            <i class="fas fa-chevron-down rotate-icon"></i>
          </div>
        </div>
      </button>
    </h2>
    <div id="{{ cid }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" aria-labelledby="heading-{{ cid }}" data-bs-parent="#monthAccordion">
      <div class="accordion-body">
        <div class="table-responsive mb-3">
          <table class="table table-modern align-middle mb-0">
            <thead>
              <tr>
                <th>Usuário</th>
                <th class="text-end">Horas no mês</th>
              </tr>
            </thead>
            <tbody>
              {% for row in month.per_user %}
                <tr>
                  <td>{{ row.user }}</td>
                  <td class="text-end fw-semibold">{{ row.hours }}</td>
                </tr>
              {% empty %}
                <tr><td colspan="2" class="text-muted text-center">Sem horas neste mês.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <div class="table-responsive">
          <table class="table align-middle table-modern">
            <thead>
              <tr>
                <th>Usuário</th>
                <th>Data</th>
                <th>Tarefa</th>
                <th>Atividade</th>
                <th class="text-end">Horas</th>
                <th>Descrição</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in month.entries %}
                <tr>
                  <td>{% if entry.timesheet and entry.timesheet.user %}{{ entry.timesheet.user.username }}{% else %}-{% endif %}</td>
                  <td>{{ entry.date|date:"d/m/Y" }}</td>
                  <td>{% if entry.task %}{{ entry.task.title }}{% else %}-{% endif %}</td>
                  <td>{% if entry.activity %}{{ entry.activity.name }}{% else %}-{% endif %}</td>
                  <td class="text-end">{{ entry.hours }}</td>
                  <td class="text-muted">{{ entry.description|default:"" }}</td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="6" class="text-center text-muted">Nenhum apontamento.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  {% endwith %}
  {% empty %}
    <div class="card"><div class="card-body text-muted">Nenhum apontamento para este projeto.</div></div>
  {% endfor %}
</div>
<div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
  <a href="{% url 'projects:project_list' %}" class="btn-back">
    <i class="fas fa-arrow-left"></i> Voltar
  </a>
</div>
{% endblock %}
